<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">   
    <title>Edit Courses</title>
    <div class = "header">
        <div class = "header-content">
            <div class = "header-text">
                <h1>Uncle Geri's Driving Academy</h1>
                <p>  804-251-0102</p>
            </div>
            <div class ="header-logo">
                <img src = "imgs/logo.png" alt="Logo">
            </div>
        </div>
        <nav class="navbar">
            <a href="courses.html"><button>Courses</button></a>
            <a href= "register.html"><button>Register</button></a>
            <a href="faq.html"><button>FAQs</button></a>
            <a href="connect.html"><button>Connect</button></a>
        </nav>    
    
    </div>
    
    </div>

</head>
<body>
    <div class="edit-course-container">
        <div class="back-button-container">
            <button class="back-button" onclick="window.location.href='admin.html'">
                &#8592; Back to Admin Dashboard
            </button>
        </div>
    <h1>Edit or Add Course</h1>
    <p>To add new lines in course details, use \n at the end of a sentence</p>
  
    <form id="courseForm">
      <label for="courseKey">Course Key</label>
      <select id="courseKeyDropdown" required>

      </select>
      <input type="text" id="newCourseKey" placeholder="Enter new course key" style="display: none;"/>
  
      <label for="courseTitle">Course Title</label>
      <input type="text" id="courseTitle" required/>
  
      <label for="courseDetails">Course Details</label>
      <textarea id="courseDetails" required></textarea>
  
      <button type="submit">Save Course</button>
    </form>
  </div>
    <div id="message"></div>
  
    <script>
      const backend = 'https://unclegeri-backend.onrender.com';
  
    document.addEventListener('DOMContentLoaded', async ()=>{
        const courseKeyDropdown = document.getElementById('courseKeyDropdown');
        const newCourseKeyInput = document.getElementById('newCourseKey');


        const newOption = document.createElement('option');
        newOption.value = 'new';
        newOption.textContent = 'Add New Course';
        courseKeyDropdown.appendChild(newOption);
        courseKeyDropdown.value = 'new';
        newCourseKeyInput.style.display = 'block';
        newCourseKeyInput.required = true;


        try{
            const res= await fetch(`${backend}/api/courses`);
            const data = await res.json();

            data.forEach(course => {
                const option = document.createElement('option');
                option.value = course.course_key;
                option.textContent = course.course_key;
                courseKeyDropdown.insertBefore(option, newOption);
            });

        }catch (err) {
            console.error('Failed to fetch courses:', err);
            document.getElementById('message').textContent = 'Could not load course information. Please try again later.';
        }
        courseKeyDropdown.addEventListener('change', ()=>{
            if(courseKeyDropdown.value=='new'){
                newCourseKeyInput.style.display='block';
                newCourseKeyInput.required = true;
            }else{
                newCourseKeyInput.style.display='none';
                newCourseKeyInput.required = false;
            }
        });
    });

      document.getElementById('courseForm').addEventListener('submit', async (e) => {
        e.preventDefault();
  
        const courseKeyDropdown = document.getElementById('courseKeyDropdown').value.trim();
        const newCourseKeyInput = document.getElementById('newCourseKey').value.trim();
        const title = document.getElementById('courseTitle').value.trim();
        const details = document.getElementById('courseDetails').value.trim();
  
        const key = courseKeyDropdown === 'new' ? newCourseKeyInput : courseKeyDropdown;


        if (!key || !title || !details) {
          document.getElementById('message').textContent = 'Please fill in all fields.';
          return;
        }

        const response = await fetch(`${backend}/api/courses`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ course_key: key, title, description:details })
        });

        if (!response.ok) {
    const errorText = await response.text(); // Read the error response as text
    console.error('Error response:', errorText);
    document.getElementById('message').textContent = 'Failed to save course. Please try again.';
    return;
  }
  
        const result = await response.json();
  
        document.getElementById('message').textContent = result.message || 'Something went wrong.';
      });
    </script>
  
  </body>
  <footer class="footer">
    <div class="footer-section">
        <h3>Learn More</h3>
        <a href="courses.html">Courses</a>
        <a href="faqs.html">FAQs</a>
    </div>
    <div class="footer-section">
        <button onclick ="window.location.href='register.html'">Register Now!</button>
    </div>
    <div class="footer-section">
        <a href="connect.html" class="footer-icon">
            <img src="imgs/message.png" alt="Connect">
        </a>
    </div>
    <div class="footer-section">
        <a href="index.html" class="footer-icon">
            <img src="imgs/home.png" alt="Home">
        </a>
    </div>
    </div>
</footer>
</html>