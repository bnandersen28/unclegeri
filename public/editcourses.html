<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Edit Courses</title>
</head>
<body>
    <div class="header">
        <div class="header-top"></div>
        <div class="header-content">

            <div class="nav-left">
                <a href="courses.html"><button>Courses</button></a>
                <a href="register.html"><button>Register</button></a>
            </div>


            <div class="header-logo">
                <img src="imgs/logo.png" alt="Logo">
            </div>

            <div class="nav-right">
                <a href="faq.html"><button>FAQs</button></a>
                <a href="connect.html"><button>Connect</button></a>
            </div>


        </div>

    </div>


    <div class="edit-course-container">
        <div class="back-button-container">
            <button class="back-button" onclick="window.location.href='admin.html'">
                &#8592; Back to Admin Dashboard
            </button>
        </div>
        <h1>Edit or Add Course</h1>
        <p>You can use <a href="https://www.markdownguide.org/basic-syntax/" target="_blank">Markdown syntax</a> in
            Course Details to format text.</p>


        <div id="courseButtonsContainer">
            <button id="newCourseBtn" class="course-button new">+ New Course</button>
            <!-- Dynamic course buttons will go here -->
        </div>

        <form id="courseForm" style="display: none;">

            </select>
            <input type="text" id="newCourseKey" placeholder="Enter new course key" style="display: none;" />

            <label for="courseTitle">Course Title</label>
            <input type="text" id="courseTitle" required />

            <label for="courseDetails">Course Details</label>
            <textarea id="courseDetails" required></textarea>

            <label for="coursePrice">Price ($)</label>
            <input type="number" id="coursePrice" step="0.01" required />

            <label for"courseStatus">Status</label>
            <select id="courseStatus" required>
                <option value="current">Current</option>
                <option value="coming">Coming</option>
            </select>

            <label for"courseDelivery">Delivery Method</label>
            <select id="courseDelivery" required>
                <option value="inperson">In Person</option>
                <option value="online">Online</option>
            </select>

            <button type="submit">Save Course</button>
        </form>
    </div>
    <div id="message"></div>

    <script>
        const backend = 'https://unclegeri-backend.onrender.com';
        let courses = {};


        document.addEventListener('DOMContentLoaded', async () => {
            const courseButtonsContainer = document.getElementById('courseButtonsContainer');
            const courseForm = document.getElementById('courseForm');
            const newCourseBtn = document.getElementById('newCourseBtn');

            const courseKeyDropdown = document.getElementById('courseKeyDropdown');
            const newCourseKeyInput = document.getElementById('newCourseKey');
            const courseTitleInput = document.getElementById('courseTitle');
            const courseDetailsInput = document.getElementById('courseDetails');
            const coursePriceInput = document.getElementById('coursePrice');
            const courseStatusInput = document.getElementById('courseStatus');
            const courseDeliveryInput = document.getElementById('courseDelivery');

            function showForm(course = null) {
                courseForm.style.display = 'block';
                if (!course) {
                    newCourseKeyInput.disabled = false;
                    newCourseKeyInput.value = '';
                    courseTitleInput.value = '';
                    courseDetailsInput.value = '';
                    coursePriceInput.value = '';
                    courseStatusInput.value = 'current';
                    courseDeliveryInput.value = 'inperson';
                } else {
                    newCourseKeyInput.disabled = true;
                    newCourseKeyInput.value = course.course_key;
                    courseTitleInput.value = course.title || '';
                    courseDetailsInput.value = course.description || '';
                    coursePriceInput.value = course.price || '';
                    courseStatusInput.value = course.status || 'current';
                    courseDeliveryInput.value = course.delivery || 'inperson';
                }
            }

            newCourseBtn.addEventListener('click', () => showForm(null));


            try {
                const res = await fetch(`${backend}/api/courses`);
                const data = await res.json();

                data.forEach(course => {
                    courses[course.course_key] = course;
                    const btn = document.createElement('button');
                    btn.textContent = course.title|| course.course_key;
                    btn.className = 'course-button';
                    btn.addEventListener('click', ()=> showForm(course));
                    courseButtonsContainer.appendChild(btn);
                });

            } catch (err) {
                console.error('Failed to fetch courses:', err);
                document.getElementById('message').textContent = 'Could not load course information. Please try again later.';
            }
        });
          

        document.getElementById('courseForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const courseKeyDropdown = document.getElementById('courseKeyDropdown').value.trim();
            const newCourseKeyInput = document.getElementById('newCourseKey').value.trim();
            const title = document.getElementById('courseTitle').value.trim();
            const description = document.getElementById('courseDetails').value.trim();
            const price = parseFloat(document.getElementById('coursePrice').value.trim());
            const status = document.getElementById('courseStatus').value;
            const delivery = document.getElementById('courseDelivery').value;

            const key = courseKeyDropdown === 'new' ? newCourseKeyInput : courseKeyDropdown;


            if (!key || !title || !description) {
                document.getElementById('message').textContent = 'Please fill in all fields.';
                return;
            }
            try {
                const response = await fetch(`${backend}/api/courses`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ course_key: key, title, description, price, status, delivery })
                });

                if (!response.ok) {
                    const errorText = await response.text(); // Read the error response as text
                    console.error('Error response:', errorText);
                    document.getElementById('message').textContent = 'Failed to save course. Please try again.';
                    return;
                }

                const result = await response.json();

                document.getElementById('message').textContent = result.message || 'Something went wrong.';
            } catch (err) {
                console.error('Error saving course:', err);
                document.getElementById('message').textContent = 'Failed to save course. Please try again.';
            }
        });
    </script>

</body>
<footer class="footer">
    <div class="footer-section">
        <h3>Learn More</h3>
        <a href="courses.html">Courses</a>
        <a href="faqs.html">FAQs</a>
    </div>
    <div class="footer-section">
        <button onclick="window.location.href='register.html'">Register Now!</button>
    </div>
    <div class="footer-section">
        <a href="connect.html" class="footer-icon">
            <img src="imgs/message.png" alt="Connect">
        </a>
    </div>
    <div class="footer-section">
        <a href="index.html" class="footer-icon">
            <img src="imgs/home.png" alt="Home">
        </a>
    </div>
    </div>
</footer>

</html>