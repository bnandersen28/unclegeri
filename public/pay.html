<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">   
    <title>Register</title>
    <script src="https://sandbox.web.squarecdn.com/v1/square.js"></script>
    </head>
    <div class = "header">
        <div class = "header-content">
            <div class = "header-text">
                <h1>Uncle Geri's Driving Academy</h1>
                <p>  804-251-0102</p>
            </div>
            <div class ="header-logo">
                <img src = "imgs/logo.png" alt="Logo">
            </div>
        </div>
        <nav class="navbar">
            <a href="courses.html"><button>Courses</button></a>
            <a href="register.html"><button>Register</button></a>
            <a href="faq.html"><button>FAQs</button></a>
            <a href="connect.html"><button>Connect</button></a>
        </nav>    
    
    </div>
    
    </div>
    <body>
        <script>
            const backend = 'https://unclegeri-backend.onrender.com';
            const appId = 'sandbox-sq0idb-k_7IL8xbgoZCAfSW0247oA';
            const locationId = 'L9JQXZK3T95MB';
      
            async function initializeCard(payments) {
              const card = await payments.card();
              await card.attach('#card-container');
      
              return card;
            }
      
            async function createPayment(token) {
              const body = JSON.stringify({
                locationId,
                sourceId: token,
                idempotencyKey: window.crypto.randomUUID(),
              });
      
              const paymentResponse = await fetch(`${backend}/payment`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body,
              });
      
              if (paymentResponse.ok) {
                return paymentResponse.json();
              }
      
              const errorBody = await paymentResponse.text();
              throw new Error(errorBody);
            }
      
            // New payment flow
            async function tokenize(paymentMethod) {
              const verificationDetails = {
                amount: '1.00',
                billingContact: {
                  givenName: 'John',
                  familyName: 'Doe',
                  email: 'john.doe@square.example',
                  phone: '3214563987',
                  addressLines: ['123 Main Street', 'Apartment 1'],
                  city: 'London',
                  state: 'LND',
                  countryCode: 'GB',
                },
                currencyCode: 'GBP',
                intent: 'CHARGE',
                customerInitiated: true,
                sellerKeyedIn: false,
              };
              const tokenResult = await paymentMethod.tokenize(verificationDetails);
              if (tokenResult.status === 'OK') {
                return tokenResult.token;
              } else {
                let errorMessage = `Tokenization failed with status: ${tokenResult.status}`;
                if (tokenResult.errors) {
                  errorMessage += ` and errors: ${JSON.stringify(
                    tokenResult.errors,
                  )}`;
                }
      
                throw new Error(errorMessage);
              }
            }
      
            // status is either SUCCESS or FAILURE;
            function displayPaymentResults(status) {
              const statusContainer = document.getElementById(
                'payment-status-container',
              );
              const successMessage = document.getElementById('success-message');
              const failureMessage = document.getElementById('failure-message');

              statusContainer.style.visibility = 'visible';
              if (status === 'SUCCESS') {
                successMessage.style.display = 'block';
                failureMessage.style.display = 'none';
              } else {
                successMessage.style.display = 'none';
                failureMessage.style.display = 'block';
              } 
      
        
            }
      
            document.addEventListener('DOMContentLoaded', async function () {
              const course = localStorage.getItem('course');
              const registrationId = localStorage.getItem('registration_id');
              console.log('Course:', course);
              console.log('Registration ID:', registrationId);

              if (!window.Square) {
                throw new Error('Square.js failed to load properly');
              }
      
              let payments;
              try {
                payments = window.Square.payments(appId, locationId);
              } catch {
                const statusContainer = document.getElementById(
                  'payment-status-container',
                );
                statusContainer.className = 'missing-credentials';
                statusContainer.style.visibility = 'visible';
                return;
              }
      
              let card;
              try {
                card = await initializeCard(payments);
              } catch (e) {
                console.error('Initializing Card failed', e);
                return;
              }
      
              async function handlePaymentMethodSubmission(event, card) {
                event.preventDefault();
      
                try {
                  // disable the submit button as we await tokenization and make a payment request.
                  cardButton.disabled = true;
                  const token = await tokenize(card);
                  const paymentResults = await createPayment(token);
                  displayPaymentResults('SUCCESS');
      
                  console.debug('Payment Success', paymentResults);
                } catch (e) {
                  cardButton.disabled = false;
                  displayPaymentResults('FAILURE');
                  console.error(e.message);
                }
              }
      
              const cardButton = document.getElementById('card-button');
              cardButton.addEventListener('click', async function (event) {
                await handlePaymentMethodSubmission(event, card);
              });
            });
          </script>
        </head>
        <body>
          <form id="payment-form">
            <div id="card-container"></div>
            <button id="card-button" type="button">Pay £1.00</button>
          </form>
          <div id="payment-status-container" style="visibility: hidden;">
            <div id="success-message" style="display: none; color: green;">
              ✅ Payment successful! Thank you.
            </div>
            <div id="failure-message" style="display: none; color: red;">
              ❌ Payment failed. Please try again.
            </div>
          </div>
        </body>

        <footer class="footer">
          <div class="footer-section">
              <h3>Learn More</h3>
              <a href="courses.html">Courses</a>
              <a href="faqs.html">FAQs</a>
          </div>
          <div class="footer-section">
              <button onclick ="window.location.href='register.html'">Register Now!</button>
          </div>
          <div class="footer-section">
              <a href="connect.html" class="footer-icon">
                  <img src="imgs/message.png" alt="Connect">
              </a>
          </div>
          <div class="footer-section">
              <a href="index.html" class="footer-icon">
                  <img src="imgs/home.png" alt="Home">
              </a>
          </div>
          </div>
      </footer>
</html>
      