<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <title>Register</title>
  <script src="https://web.squarecdn.com/v1/square.js"></script>
</head>
<div class="header">
  <div class="header-top"></div>
  <div class="header-content">

    <div class="nav-left">
      <a href="courses.html"><button>Courses</button></a>
      <a href="register.html"><button>Register</button></a>
    </div>


    <div class="header-logo">
      <img src="imgs/logo.png" alt="Logo">
    </div>

    <div class="nav-right">
      <a href="faq.html"><button>FAQs</button></a>
      <a href="connect.html"><button>Connect</button></a>
    </div>


  </div>

</div>
</head>

<body>


  <body>
    <div id="price-container"></div>
    <div id="payment-options">
      <button id="cash-button">I'm Paying Cash</button>
      <button id="check-button">I'm Paying by Check</button>
      <button id="card-pay-button">Pay with Card</button>
    </div>

    <div id="cash-check-container" style="display: none;">
      <h2>Do you agree to provide payment at the first session?</h2>
      <button id="confirm">Yes, I agree</button>
    </div>

    <div id="card-info" class="card-info" style="display: none;">
      <form id="customer-info-form" class="customer-info-form">
        <label for="first-name">First Name:</label>
        <input type="text" id="first-name" required><br>

        <label for="last-name">Last Name:</label>
        <input type="text" id="last-name" required><br>

        <label for="email">Email:</label>
        <input type="email" id="email"><br>

        <label for="phone">Phone:</label>
        <input type="tel" id="phone"><br>
      </form>
      <form id="payment-form" class="payment-form">
        <div id="card-container"></div>
        <button id="card-button" type="button">Pay</button>
      </form>
    </div>

    <div id="confirmation-message" style="display: none; ">
      <p>✅ Thank you! Your registration has been confirmed.</p>

      <p>You should be hearing from Uncle Geri soon to confirm pickup times and locations. In the meantime, if you are
        under 18 and completing the Behind the Wheel course, please confirm you have your green card from completing
        Driver's Education. </p>

      <p>If you have any questions, feel free to reach out to Chris by email or through our contact form.
      </p>
    </div>

    <div id="payment-status-container" style="visibility: hidden;">
      <div id="success-message" style="display: none; color: green;">
        ✅ Payment successful! Thank you.
      </div>
      <div id="failure-message" style="display: none; color: red;">
        ❌ Payment failed. Please try again.
      </div>
    </div>
  </body>

  <footer class="footer">
    <div class="footer-section">
      <h3>Learn More</h3>
      <a href="courses.html">Courses</a>
      <a href="faqs.html">FAQs</a>
    </div>
    <div class="footer-section">
      <button onclick="window.location.href='register.html'">Register Now!</button>
    </div>
    <div class="footer-section">
      <a href="connect.html" class="footer-icon">
        <img src="imgs/message.png" alt="Connect">
      </a>
    </div>
    <div class="footer-section">
      <a href="index.html" class="footer-icon">
        <img src="imgs/home.png" alt="Home">
      </a>
    </div>
    </div>
  </footer>

  <script>
    const backend = 'https://unclegeri-backend.onrender.com';
    let appId = '';
    let locationId = '';
    let price;
    let isCardInitialized = false;
    let card;

    // Fetch the App ID from the backend
    async function fetchConfig() {
      try {
        const response = await fetch(`${backend}/config`);
        const data = await response.json();
        appId = data.appId;
        locationId = data.locationId;
        console.log('App ID fetched:', appId);
        console.log('Location ID fetched:', locationId);
      } catch (error) {
        console.error('Error fetching App ID:', error);
      }
    }

    // Call the fetch function to get the App ID when the page loads
    fetchConfig();


    document.addEventListener('DOMContentLoaded', async function () {
      const course = localStorage.getItem('course_title');
      const courseId = localStorage.getItem('course_id');
      const rawPrice = localStorage.getItem('course_price');
      const registrationId = localStorage.getItem('registration_id');
      console.log('Course:', course);
      console.log('Course price: ', rawPrice);
      console.log('Course ID:', courseId);
      console.log('Registration ID:', registrationId);

      let payment_method = null;



      // Check if course exists in localStorage
      if (!course || !registrationId || !rawPrice) {
        alert('No course or registration ID found. Please complete the registration first.');
        window.location.href = '/register.html'; // Redirect back to registration
        return;
      }

      // Convert price to cents
      price = Math.round(parseFloat(rawPrice)).toString(); //convert dollars to cents
      console.log('Price in cents:', price);

      if (isNaN(price)) {
        console.error('invalid course price', price);
        alert('Invalid course selected. Please try again.');
      }

      // Update the price container with course name and price
      const priceContainer = document.getElementById('price-container');
      priceContainer.innerHTML = `
    <h2>Selected Course: ${course}</h2>
    <h3>Course Price: $${rawPrice}</h3>
  `;

      if (!window.Square) {
        throw new Error('Square.js failed to load properly');
      }

      let payments;
      try {
        payments = window.Square.payments(appId, locationId);
      } catch {
        const statusContainer = document.getElementById(
          'payment-status-container',
        );
        statusContainer.className = 'missing-credentials';
        statusContainer.style.visibility = 'visible';
        return;
      }

      if (!isCardInitialized) {
        try {
          card = await initializeCard(payments);
          isCardInitialized = true;
        } catch (e) {
          console.error('Initializing Card failed', e);
          return;
        }
      }

      const cardButton = document.getElementById('card-button');
      cardButton.addEventListener('click', async function (event) {
        await handlePaymentMethodSubmission(event, card);
      });
    });

    async function initializeCard(payments) {
      if (!window.Square) {
        console.error("Square.js failed to load.");
        return;
      }
      const card = await payments.card();
      await card.attach('#card-container');
      return card;
    }


    async function handlePaymentMethodSubmission(event, card) {
      event.preventDefault();

      try {
        // disable the submit button as we await tokenization and make a payment request.
        cardButton.disabled = true;
        const token = await tokenize(card, price);
        const paymentResults = await createPayment(token, price);
        displayPaymentResults('SUCCESS');

        console.debug('Payment Success', paymentResults);
      } catch (e) {
        cardButton.disabled = false;
        displayPaymentResults('FAILURE');
        console.error(e.message);
      }
    }


    // New payment flow
    async function tokenize(paymentMethod, price) {
      //Get details from the form 
      const firstName = document.getElementById('first-name').value;
      const lastName = document.getElementById('last-name').value;
      const email = document.getElementById('email').value;
      const phone = document.getElementById('phone').value;

      console.log('Tokenizing with details:', {
        firstName,
        lastName,
        email,
        phone,
        price,
      });

      console.log("price variable type,", typeof price);

      const verificationDetails = {
        amount: price,
        billingContact: {
          givenName: firstName,
          familyName: lastName,
          email: email,
          phone: phone,
          countryCode: 'US',
        },
        currencyCode: 'USD',
        intent: 'CHARGE',
        customerInitiated: true,
        sellerKeyedIn: false,
      };
      const tokenResult = await paymentMethod.tokenize(verificationDetails);
      console.log('Tokenization result:', tokenResult);
      if (tokenResult.status === 'OK') {
        return tokenResult.token;
      } else {
          throw new Error(`Tokenization failed: ${JSON.stringify(tokenResult.errors)}`);
        }
      }



    async function createPayment(token, price) {
      const body = JSON.stringify({
        locationId,
        sourceId: token,
        idempotencyKey: window.crypto.randomUUID(),
        amount: parseInt(price),
      });

      const paymentResponse = await fetch(`${backend}/payment`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body,
      });

      if (paymentResponse.ok) {
        return paymentResponse.json();
      }

      const errorBody = await paymentResponse.text();
      throw new Error(errorBody);
    }
  


    // status is either SUCCESS or FAILURE;
    function displayPaymentResults(status) {
      const statusContainer = document.getElementById(
        'payment-status-container',
      );
      const successMessage = document.getElementById('success-message');
      const failureMessage = document.getElementById('failure-message');

      statusContainer.style.visibility = 'visible';
      if (status === 'SUCCESS') {
        successMessage.style.display = 'block';
        failureMessage.style.display = 'none';
      } else {
        successMessage.style.display = 'none';
        failureMessage.style.display = 'block';
      }


    }

    //Display cash/check confirmation
    document.getElementById('cash-button').addEventListener('click', () => {
      console.log('Cash payment selected');
      payment_method = 'cash';
      document.getElementById('cash-check-container').style.display = 'block';
      document.getElementById('payment-options').style.display = 'none';
    });

    document.getElementById('check-button').addEventListener('click', () => {
      document.getElementById('cash-check-container').style.display = 'block';
      payment_method = 'check';
      document.getElementById('payment-options').style.display = 'none';
    });

    //Send card/check payment notification to backend
    document.getElementById('confirm').addEventListener('click', async () => {
      console.log('Cash/Check payment confirmed');

      //check if payment method is correctly set
      // Check if payment method is correctly set
      if (!payment_method) {
        alert('Payment method not selected. Please choose Cash or Check.');
        return;
      }
      console.log('Payment method: ' + payment_method);

      //send payment method to backend
      const body = JSON.stringify({
        id: localStorage.getItem('registration_id'),
        payment_method: payment_method,
      });

      const response = await fetch(`${backend}/payment-method`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body,
      });

      if (response.ok) {
        document.getElementById('confirmation-message').style.display = 'block';
        document.getElementById('cash-check-container').style.display = 'none';
      } else {
        const errorData = await response.json();
        alert(`Failed to submit payment method: ${errorData.message}`);
      }
    });


    //Send notification of card payment to backend
    document.getElementById('card-pay-button').addEventListener('click', async () => {
      console.log('Card payment button clicked');  // Debugging


      document.getElementById('payment-options').style.display = 'none';
      document.getElementById('card-info').style.display = 'block';

      //Ensure card is intialized 
      // Ensure card is initialized before proceeding
      if (!isCardInitialized) {
        try {
          await initializeCard(payments);
        } catch (e) {
          console.error('Failed to initialize the card:', e);
          return;  // Stop execution if the card cannot be initialized
        }
      }

      // Wait for the payment method to be tokenized
      try {
        const token = await tokenize(card, price);
        // Send payment method to the backend after tokenization
        await sendPaymentMethodToBackend(token);
      } catch (error) {
        console.error('Payment method submission failed:', error);
        alert('Payment failed. Please try again.');
        return;
      }
    });

    async function sendPaymentMethodToBackend(token) {


      let payment_method = 'card';        //send payment method to backend

      if (!registrationId) {
        console.error('Registration ID not found.');
        return;
      }
      const body = JSON.stringify({
        id: localStorage.getItem('registration_id'),
        payment_method: payment_method,
        token: token,
      });

      const response = await fetch(`${backend}/payment-method`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body,
      });
      if (!response.ok) {
        const errorData = await response.json();
        alert(`Failed to submit payment method: ${errorData.message}`);
        return;
      }
      console.log('Payment method submitted successfully');
    }




  </script>

</html>