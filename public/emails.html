<!DOCTYPE html>
<html lang="en">
<script>
    if (localStorage.getItem('authenticated') !== 'true') {
        alert('You must be logged in to access this page.');
        window.location.href = 'login.html';
    }
</script>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Edit emails</title>
    <!-- Quill -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
</head>

<body>
    <div class="header">
        <div class="header-top"></div>
        <div class="header-content">

            <div class="nav-left">
                <a href="courses.html"><button>Courses</button></a>
                <a href="register.html"><button>Register</button></a>
            </div>


            <a href="index.html" class="header-logo">
                <img src="imgs/logo.png" alt="Logo">
            </a>

            <div class="nav-right">
                <a href="faq.html"><button>FAQs</button></a>
                <a href="connect.html"><button>Connect</button></a>
            </div>


        </div>

    </div>

    <div class="container">
        <h1>Edit Course Emails</h1>

        <!-- Course block -->
        <div class="course-item" data-course-key="behind_the_wheel">
            <div class="course-header" onclick="toggleForm('form1')">Behind the Wheel</div>
            <div class="course-form" id="form1">
                <label>Subject:</label><br>
                <input type="text" id="subject1" name="subject" placeholder="Email subject"><br><br>
                <label>Body:</label>
                <div id="editor1" style="height:150px; background:white;"></div>
                <button type="button" onclick="saveEmail(this)">Save</button>
            </div>
        </div>

        <div class="course-item" data-course-key="one_on_one">
            <div class="course-header" onclick="toggleForm('form2')">1-1 Driving Lessons</div>
            <div class="course-form" id="form2">
                <label>Subject:</label><br>
                <input type="text" id="subject2" name="subject" placeholder="Email subject"><br><br>
                <label>Body:</label>
                <div id="editor2" style="height:150px; background:white;"></div>
                <button type="button" onclick="saveEmail(this)">Save</button>
            </div>
        </div>
        <div class="course-item" data-course-key="adult_road_test">
            <div class="course-header" onclick="toggleForm('form3')">Adult Road Test</div>
            <div class="course-form" id="form3">
                <label>Subject:</label><br>
                <input type="text" id="subject3" name="subject" placeholder="Email subject"><br><br>
                <label>Body:</label>
                <div id="editor3" style="height:150px; background:white;"></div>
                <button type="button" onclick="saveEmail(this)">Save</button>
            </div>
        </div>

        <div class="course-item" data-course-key="online_de">
            <div class="course-header" onclick="toggleForm('form4')">Online Driver's Education</div>
            <div class="course-form" id="form4">
                <label>Subject:</label><br>
                <input type="text" id="subject4" name="subject" placeholder="Email subject"><br><br>
                <label>Body:</label>
                <div id="editor4" style="height:150px; background:white;"></div>
                <button type="button" onclick="saveEmail(this)">Save</button>
            </div>
        </div>
        <div class="course-item" data-course-key="driver_manual_3xf">
            <div class="course-header" onclick="toggleForm('form5')">Driver Manual 3XF</div>
            <div class="course-form" id="form5">
                <label>Subject:</label><br>
                <input type="text" id="subject5" name="subject" placeholder="Email subject"><br><br>
                <label>Body:</label>
                <div id="editor5" style="height:150px; background:white;"></div>
                <button type="button" onclick="saveEmail(this)">Save</button>
            </div>
        </div>
        <div class="course-item" data-course-key="driver_improvement">
            <div class="course-header" onclick="toggleForm('form6')">Driver Improvement Clinic</div>
            <div class="course-form" id="form6">
                <label>Subject:</label><br>
                <input type="text" id="subject6" name="subject" placeholder="Email subject"><br><br>
                <label>Body:</label>
                <div id="editor6" style="height:150px; background:white;"></div>
                <button type="button" onclick="saveEmail(this)">Save</button>
            </div>
        </div>

    </div>

    <script>
        const backend = 'https://unclegeri-backend.onrender.com';
        
        // Initialize Quill editors based on edit ids
        function initEditors() {
            document.querySelectorAll('[id^="editor"]').forEach(ed => {
                new Quill('#' + ed.id, {
                    theme: 'snow'
                });
            });
        }

        // Toggle visibility of forms
        function toggleForm(id) {
            const form = document.getElementById(id);
            form.style.display = form.style.display === "block" ? "none" : "block";
        }

        // Save email (send to backend)
        async function saveEmail(buttonEl) {
            const courseItem = buttonEl.closest('.course-item');
            const courseKey = courseItem.dataset.courseKey;

            const subjectInput = courseItem.querySelector('input[name="subject"]');
            const editorEl = courseItem.querySelector('[id^="editor"]');
            const quill = editorEl.__quill;

            const payload = {
                courseKey,
                subject: subjectInput.value || '',
                body: quill.root.innerHTML || ''
            }

            if (!payload.subject.trim()) {
                alert('Please enter a subject.');
                return;
            }

            try {
                const res = await fetch(`${backend}/api/email-templates`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include', // send session cookie
                    body: JSON.stringify(payload)
                });
                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(text || 'Failed to save template');
                }
                alert('Saved successfully!');
            } catch (e) {
                console.error(e);
                alert('Error saving email: ' + e.message);
            }
        }


        // Load existing templates and prefill each block
        async function loadTemplates() {
            const items = document.querySelectorAll('.course-item');
            for (const item of items) {
                const courseKey = item.dataset.courseKey;
                try {
                    const res = await fetch(`${backend}/api/email-templates?courseKey=${encodeURIComponent(courseKey)}`, {
                        credentials: 'include'
                    });
                    if (res.status === 404) continue; // no template yet
                    if (!res.ok) {
                        console.warn('Failed to fetch template for', courseKey);
                        continue;
                    }
                    const tpl = await res.json(); // { subject, bodyHtml }
                    const subjectInput = item.querySelector('input[name="subject"]');
                    const editorEl = item.querySelector('[id^="editor"]');
                    const quill = editorEl.__quill;

                    if (tpl.subject) subjectInput.value = tpl.subject;
                    if (tpl.bodyHtml) quill.root.innerHTML = tpl.bodyHtml;
                } catch (e) {
                    console.warn('Fetch error for', courseKey, e);
                }
            }
        }

        //When page loads, initialize Quill editors and load templates
        document.addEventListener('DOMContentLoaded', () => {
            initEditors();
            loadTemplates();
        });
    </script>
</body>
<footer class="footer">
  <div class="footer-section">
    <h3>Learn More</h3>
    <a href="courses.html">Courses</a>
    <a href="faqs.html">FAQs</a>
  </div>
  <div class="footer-section">
    <button onclick="window.location.href='register.html'">Register Now!</button>
  </div>
  <div class="footer-section">
    <a href="connect.html" class="footer-icon">
      <img src="imgs/message.png" alt="Connect">
    </a>
  </div>
  <div class="footer-section">
    <a href="index.html" class="footer-icon">
      <img src="imgs/home.png" alt="Home">
    </a>
  </div>
  </div>
</footer>

</html>